<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Paint Pro - Smart Mask</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0c182d; color: white; text-align: center; }
        .page { display: none; width: 100%; max-width: 420px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }
        
        .video-wrapper { position: relative; width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        video, canvas { width: 100%; display: block; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; mix-blend-mode: color; }
        
        .color-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .swatch { height: 50px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
        .swatch.selected { border-color: white; transform: scale(1.1); }
        .action-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: #f39c12; color: white; }
    </style>
</head>
<body>

    <div id="menuPage" class="page active">
        <h1 style="margin-top:40px;">üè† HOME PAINT PRO</h1>
        <p>Record a room with light-colored walls.</p>
        <input type="file" accept="video/*" capture="environment" id="vIn" onchange="startSmartEdit(event)">
        <button class="action-btn" onclick="document.getElementById('vIn').click()">CAPTURE & PAINT</button>
    </div>

    <div id="editPage" class="page">
        <h2>Smart Wall Paint</h2>
        <div class="video-wrapper">
            <video id="mainVid" loop muted autoplay playsinline></video>
            <canvas id="paintCanvas"></canvas>
        </div>
        
        <div class="color-grid">
            <div class="swatch" style="background:#3498db" onclick="setPaint('#3498db')"></div>
            <div class="swatch" style="background:#e67e22" onclick="setPaint('#e67e22')"></div>
            <div class="swatch" style="background:#77dd77" onclick="setPaint('#77dd77')"></div>
            <div class="swatch" style="background:#ffb7c5" onclick="setPaint('#ffb7c5')"></div>
            <div class="swatch" style="background:#95a5a6" onclick="setPaint('#95a5a6')"></div>
            <div class="swatch" style="background:#f1c40f" onclick="setPaint('#f1c40f')"></div>
        </div>
        <button class="action-btn" onclick="location.reload()">START OVER</button>
    </div>

    <script>
        const video = document.getElementById('mainVid');
        const canvas = document.getElementById('paintCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let paintColor = { r: 0, g: 0, b: 0 };

        function startSmartEdit(event) {
            const file = event.target.files[0];
            video.src = URL.createObjectURL(file);
            document.getElementById('menuPage').classList.remove('active');
            document.getElementById('editPage').classList.add('active');
            
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                renderPaint();
            };
        }

        function setPaint(hex) {
            // Convert Hex to RGB for the processor
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            paintColor = { r, g, b };
        }

        function renderPaint() {
            if (video.paused || video.ended) return;

            // 1. Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 2. Get pixel data
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // 3. THE MASK LOGIC: 
                // If the pixel is "bright" (likely a wall), apply color.
                // If it's "dark" (furniture/shadows), make it transparent.
                const brightness = (r + g + b) / 3;
                
                if (brightness > 120) { // Threshold for "Wall"
                    data[i] = paintColor.r;
                    data[i + 1] = paintColor.g;
                    data[i + 2] = paintColor.b;
                    data[i + 3] = 180; // Opacity of the paint
                } else {
                    data[i + 3] = 0; // Transparent
                }
            }

            ctx.putImageData(frame, 0, 0);
            requestAnimationFrame(renderPaint);
        }
    </script>
</body>
</html>
