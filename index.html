<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wall Paint Visualization</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0a0a0a; color: white; text-align: center; }
        .page { display: none; width: 100%; max-width: 450px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .active { display: block; }
        
        /* Buttons */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 15px; font-size: 1rem; transition: 0.2s; }
        .btn-upload { background: #3498db; color: white; }
        .btn-storage { background: #2ecc71; color: white; }
        .btn-colors { background: #9b59b6; color: white; }
        .btn-back { background: transparent; border: 1px solid #444; color: #888; margin-top: 20px; }

        /* Scanning Logic Display */
        .video-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; background: #000; margin-top: 10px; }
        video { width: 100%; display: none; }
        canvas { width: 100%; display: block; }
        
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; }
        .swatch { height: 40px; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
        .swatch.active { border-color: white; transform: scale(1.1); }
        
        .status-pill { display: inline-block; padding: 5px 15px; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; color: #2ecc71; }
        .list-card { background: #1a1a1a; padding: 10px; border-radius: 12px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="homePage" class="page active">
        <h1 style="margin-top:50px;">Wall Paint Visualization</h1>
        <p style="color: #666; margin-bottom: 40px;">Professional Grade AI Wall Scanning</p>
        
        <button class="btn btn-upload" onclick="showPage('instructionPage')">UPLOAD VIDEO</button>
        <button class="btn btn-storage" onclick="openStorage()">STORAGE</button>
        <button class="btn btn-colors" onclick="showPage('colorMenuPage')">COLOR PALETTE</button>
    </div>

    <div id="instructionPage" class="page">
        <h2>Capture Room</h2>
        <p style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px;">
            Please record a <strong>3-second video</strong> of the room. Keep the camera steady and ensure the white walls are clearly visible.
        </p>
        <input type="file" id="camInput" accept="video/*" capture="environment" style="display:none" onchange="processUpload(event)">
        <button class="btn btn-upload" onclick="document.getElementById('camInput').click()">OPEN CAMERA</button>
        <button class="btn btn-back" onclick="showPage('homePage')">CANCEL</button>
    </div>

    <div id="storagePage" class="page">
        <h2>Video Storage</h2>
        <div id="storageList"></div>
        <button class="btn btn-back" onclick="showPage('homePage')">HOME</button>
    </div>

    <div id="colorMenuPage" class="page">
        <h2>Available Colors</h2>
        <p>Preview our 10 professional hues</p>
        <div class="color-grid" id="previewGrid"></div>
        <button class="btn btn-back" onclick="showPage('homePage')">HOME</button>
    </div>

    <div id="editPage" class="page">
        <div class="status-pill" id="statusPill">AI SCANNING SURFACE...</div>
        <div class="video-container">
            <video id="sourceVid" loop muted playsinline></video>
            <canvas id="editorCanvas"></canvas>
        </div>
        <div class="color-grid" id="editorGrid"></div>
        <button class="btn btn-back" onclick="stopEditor()">CLOSE EDITOR</button>
    </div>

    <script>
        const appColors = [
            {h: '#FFFFFF', r: 255, g: 255, b: 255, n: 'Swiss White'},
            {h: '#F5F5DC', r: 245, g: 245, b: 220, n: 'Beige'},
            {h: '#D7DBDD', r: 215, g: 219, b: 221, n: 'Cloud Grey'},
            {h: '#3498db', r: 52, g: 152, b: 219, n: 'Ocean'},
            {h: '#2ecc71', r: 46, g: 204, b: 113, n: 'Sage'},
            {h: '#E67E22', r: 230, g: 126, b: 34, n: 'Terra Cotta'},
            {h: '#9b59b6', r: 155, g: 89, b: 182, n: 'Lavender'},
            {h: '#F1C40F', r: 241, g: 196, b: 15, n: 'Mustard'},
            {h: '#E74C3C', r: 231, g: 76, b: 60, n: 'Ruby'},
            {h: '#1ABC9C', r: 26, g: 188, b: 156, n: 'Teal'}
        ];

        let activeRGB = null; 
        let currentStreamId = null;
        const video = document.getElementById('sourceVid');
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- STORAGE LOGIC ---
        function processUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                let storage = JSON.parse(localStorage.getItem('wp_storage') || '[]');
                storage.push({ id: Date.now(), data: reader.result });
                localStorage.setItem('wp_storage', JSON.stringify(storage));
                openStorage();
            };
            reader.readAsDataURL(file);
        }

        function openStorage() {
            const list = document.getElementById('storageList');
            list.innerHTML = "";
            let storage = JSON.parse(localStorage.getItem('wp_storage') || '[]');
            storage.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-card';
                div.innerHTML = `<video src="${item.data}" style="width:100%; border-radius:8px;"></video>
                                 <button class="btn btn-storage" style="margin-top:10px" onclick="startAI('${item.data}')">EDIT WALLS</button>`;
                list.appendChild(div);
            });
            showPage('storagePage');
        }

        // --- COLOR MENU ---
        function initColors() {
            const preview = document.getElementById('previewGrid');
            const editor = document.getElementById('editorGrid');
            appColors.forEach(c => {
                const div = document.createElement('div');
                div.className = 'swatch'; div.style.background = c.h;
                preview.appendChild(div.cloneNode(true));
                div.onclick = () => { activeRGB = c; };
                editor.appendChild(div);
            });
        }

        // --- AI SCANNER ---
        function startAI(src) {
            video.src = src;
            activeRGB = null;
            document.getElementById('statusPill').innerText = "AI SCANNING SURFACE...";
            showPage('editPage');
            video.play();
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                requestAnimationFrame(aiLoop);
            };
        }

        function aiLoop() {
            if (video.paused || video.ended) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                
                // AI DETECTION: Identify white, flat surfaces
                const isWhite = r > 180 && g > 180 && b > 180;
                const isFlat = Math.abs(r - g) < 15 && Math.abs(g - b) < 15;

                if (isWhite && isFlat) {
                    if (!activeRGB) {
                        // HIGHLIGHT MODE: Show what can be changed
                        data[i] = 46; data[i+1] = 204; data[i+2] = 113; // Green highlight
                        data[i+3] = 150; 
                    } else {
                        // PAINT MODE: Apply selected color
                        document.getElementById('statusPill').innerText = "SURFACE PAINTED";
                        data[i] = (r * activeRGB.r) / 255;
                        data[i+1] = (g * activeRGB.g) / 255;
                        data[i+2] = (b * activeRGB.b) / 255;
                    }
                }
            }
            ctx.putImageData(frame, 0, 0);
            currentStreamId = requestAnimationFrame(aiLoop);
        }

        function stopEditor() {
            cancelAnimationFrame(currentStreamId);
            video.pause();
            showPage('storagePage');
        }

        initColors();
    </script>
</body>
</html>
